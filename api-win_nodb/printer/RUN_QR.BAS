REM ADA6OMQ/CL10A475KP8NNNC/0032/0004000
REM Set INPUT LINE Feed Code is CRLF.
LFC "CR"
REM Disable INPUT LINE timeout.
SC=SYSINFOSET(wlbInputNoDataTimeOut,0)
REM Set INPUT LINE no end timeout 1 second.
SC=SYSINFOSET(wlInputNoLineEndTimeOut, 10)
REM Disable Input Echo
REM SC=SYSINFOSET(wlInputECHO, 0)

SUB MAIN
  ON ERROR GOTO EXIT_BAS
  CALL AUTH

  TPL_ID_POST&=TPL_CREATE(4)
  DO
    TPL_ID_RSP&=TPL_CREATE(10)
    PRINT "Input QR: ";
    INPUT LINE LINE_STR$
    B64$=BASE64_ENCODE$(LINE_STR$)
    N=TPL_SET(TPL_ID_POST&,"input_QR",B64$)
    POST$=TPL_STR$(TPL_ID_POST&)
    HTTPC "BEARER_POST" URI "https://192.168.7.216:5000/job" POST POST$ RET TPL_ID_RSP&

    DEBUG$=TPL_STR$(TPL_ID_RSP&)
    PRINT DEBUG$

    IF TPL_GET$(TPL_ID_RSP&,"reply code") = "201" THEN
      IF TPL_GET$(TPL_ID_RSP&,"status") = "OK" THEN
        A$=BASE64_DECODE$(TPL_GET$(TPL_ID_RSP&,"input_QR"))
        N=TPL_SET(TPL_ID_RSP&,"FullQR",A$)

        FILE_TPL_NAME$="0.TPL"
        IF EXIST(FILE_TPL_NAME$) > 0 THEN
          LPF FILE_TPL_NAME$ WITH TPL_ID_RSP&
        END IF
      END IF
    END IF
    N=TPL_RELEASE(TPL_ID_RSP&)
  LOOP

EXIT_BAS:
  N=TPL_RELEASE(TPL_ID_POST&)
  PRINT "Exit BASIC"
END SUB

SUB AUTH
  TPL_ID_AUTH&=TPL_CREATE(4)
  N=TPL_SET(TPL_ID_AUTH&,"userName",SYSINFOGET$(rsPntSN))
  AUTH_POST$=TPL_STR$(TPL_ID_AUTH&)
  HTTPC "BEARER_AUTH" URI "https://192.168.7.216:5000/getToken" POST AUTH_POST$ SECURE "Demo"
  N=TPL_RELEASE(TPL_ID_AUTH&)
END SUB

CALL MAIN
END
